import{colors}from"../../Constants/colors.js";import{gameData}from"../../Constants/gameData.js";import{sightsData}from"../../Constants/sightsData.js";import{App}from"./Game.js";import{gainNode,audioContext}from"./../../Js/script.js";import{audioDataArray}from"../../Constants/songsData.js";let aux=0;class Sights{constructor(e,t){this.location={name:e},this.element=document.querySelector(`.${this.location.name}`),this.currentAudios=t,this.audioContext=audioContext,this.gainNode=gainNode,this.initialControlsIndex=1,this.ctrFlag=!1,this.optFlag=!1,this.isPLaying=!1,this.ctrCurrentIdx=void 0,this.optionsAmount=Object.keys(sightsData[this.location.name].samples).length,this.choicesAmount=5,this.chosenAnimalsNameArr=[],this.chosenContainerIdxArr=[],this.handleOptionsNavigation=this.optionNavigation.bind(this),this.handleControlersNavigation=this.controlsNavigation.bind(this),this.handleControlersSelection=this.controlersSelection.bind(this),this.handleKeyDown=e=>{this.handleOptionsNavigation(e),this.handleControlersNavigation(e)},this.textToBeRead=document.getElementById("textToReader"),this.start(),document.title=`Mesa de som do ${capitalizeStr(this.location.name.split("_").join(" "))}`,gameData.mainScene=capitalizeStr(this.location.name)}start(){this.buildContainer(),this.setContainerElements(),gameData.isClickable=!0,this.playAudio(sightsData[this.location.name].mainSampleName,sightsData[this.location.name].mainSampleVolume,!0)}buildContainer(){const e=this.createNewElement("div","sgh_bg","sgh_bg"),t=this.createNewElement("img","preguica left","sgh_preg_r","./../Assets/imgs/preguica_pre.png"),s=this.createNewElement("img","preguica right","sgh_preg_l","./../Assets/imgs/preguica_pre.png");t.setAttribute("alt","Bicho preguiça ouvindo música"),s.setAttribute("alt","Bicho preguiça ouvindo música"),e.append(t,s),this.element.appendChild(e);const i=this.createNewElement("div","sgh_menu container","sgh_menu"),o=this.createNewElement("img","setting_board_img","setting_board_img","./../Assets/imgs/controlerG4.png"),n=this.createNewElement("div","sgh_menu_list","sgh_menu_list"),a=this.createNewElement("img","setting_board_img_control","setting_board_img_control","./../Assets/imgs/mesaG4.png"),r=this.createNewElement("div","sgh_choices_control","sgh_choices_control"),l=this.createNewElement("span","sgh_choices_made","sgh_choices_made"),c=this.createNewElement("span","sgh_choices_amount","sgh_choices_amount");o.setAttribute("alt","ilustração do menu"),o.setAttribute("tabindex",1),o.setAttribute("aria-label","Essa é sua mesa de som"),a.setAttribute("alt","Mixando audio"),r.setAttribute("title",`Voce pode escolher ${this.choicesAmount-0} opções de um total de ${this.choicesAmount}`);const u=this.createNewElement("ul","sgh_menu_body","sgh_menu_body"),m=this.createNewElement("div","sgh_menu_body_wrapper"),h=this.createNewElement("p","sgh_menu_head"),d=this.createNewElement("p","sgh_menu_head_wrapper");h.textContent=`Escolha até ${this.choicesAmount} faixas para tocar`,h.setAttribute("tabindex",1),m.appendChild(u),d.appendChild(h),n.append(d,m);((e,t)=>{let s=0;for(let i in e){let o=this.createNewElement("span","sgh_menu_row"),n=this.createNewElement("li","sgh_menu_opt",`menuItem${s}`),a=this.createNewElement("img","sgh_menu_opt_img",void 0,"./../Assets/imgs/notasG4.gif");n.textContent=capitalizeStr(e[i].alt),a.setAttribute("alt","notas musicais"),a.setAttribute("inert",""),o.setAttribute("tabindex",s+2),o.setAttribute("index",s),o.setAttribute("aria-dscribedby",`menuItem${s}`),o.setAttribute("role","menuitem"),o.setAttribute("title","Clique para adicionar esse som na sua musica"),s++,o.append(n,a),t.append(o),n.addEventListener("click",(e=>{this.chosenAnimalsNameArr.length}))}})(sightsData[this.location.name].samples,u),l.textContent=0,c.textContent=this.choicesAmount;const p=document.createTextNode("/");r.append(l,p,c),i.append(o,n,a,r),this.element.appendChild(i);const g=this.createNewElement("div","sgh_sounds_board_wrapper container"),A=this.createNewElement("div","sgh_sounds_board");for(let e=0;e<20;e++){let e=this.createNewElement("div","sample_img_wrapper container");A.append(e)}const _=this.createNewElement("div","sgh_soundControl_wrapper container"),f=this.createNewElement("button","play_pause_btn","play_pause_btn"),b=this.createNewElement("i","fa-solid fa-play"),v=this.createNewElement("button","trash_btn","trash_btn"),y=this.createNewElement("i","fa-solid fa-trash"),N=this.createNewElement("button","home_btn","home_btn"),C=this.createNewElement("i","fa-solid fa-house");let E=this.optionsAmount+2;f.setAttribute("tabindex",E++),f.setAttribute("title","Clique para tocar a sua música"),f.setAttribute("aria-label","tocar a sua musica"),v.setAttribute("tabindex",E++),v.setAttribute("title","Clique para limpar escolhas feitas"),v.setAttribute("aria-label","limpar escolhas feitas"),N.setAttribute("tabindex",E),N.setAttribute("title","Clique para voltar para página inicial"),N.setAttribute("aria-label","voltar para página inicial"),f.append(b),v.appendChild(y),N.appendChild(C),_.append(N,f,v),g.append(A,_),this.element.append(g)}setContainerElements(){const e=sightsData[this.location.name].bgUrl;this.setBackground(e);const t=document,s=t.getElementById("play_pause_btn"),i=t.getElementById("trash_btn"),o=t.getElementById("home_btn"),n=t.querySelectorAll(".sgh_menu_row");i.addEventListener("click",(()=>this.handleTrashToReset())),s.addEventListener("click",(e=>this.handlePlayAndPauseBtn(e,this.chosenAnimalsNameArr))),o.addEventListener("click",(e=>this.callHomeScene(App))),t.addEventListener("keydown",this.handleKeyDown),t.addEventListener("keyup",this.handleControlersSelection),n&&n.forEach(((e,t)=>{e.addEventListener("focus",(e=>this.onTableElementFocus(e))),e.addEventListener("click",(e=>this.chooseAnimal(e,t)))})),[s,i,o].forEach((e=>{e.addEventListener("focus",(e=>this.onControlsElementFocus))}))}createNewElement(e,t="",s="",i=""){const o=document.createElement(e);return t&&o.classList.add(...t.split(" ")),s&&o.setAttribute("id",s),i&&o.setAttribute("src",i),o}resetSampleBoard(){const e=document.querySelectorAll(".sample_img");e&&(e.forEach((e=>function(e){"string"==typeof e&&((e=document.getElementById(e))||(e=document.querySelector(e)));e&&e.parentNode?e.parentNode.removeChild(e):console.warn("Elemento não encontrado ou já foi removido do DOM.")}(e))),this.chosenAnimalsNameArr=[],this.chosenContainerIdxArr=[],this.updateChoicesInterface())}playAudio(e,t=1,s=!1){let i,o;if(!(e in this.currentAudios)){o=this.audioContext.createBufferSource(),i=this.audioContext.createGain();const n=gameAssets[e];o.buffer=n,o.loop=s;let a=sightsData[this.location.name].mainSampleVolume||t;if(i.gain.value=gameData.isMute?0:a,o.connect(i),i.connect(this.audioContext.destination),o.start(0,0),!0===s)this.currentAudios[e]={config:{startTime:0,pausedAt:void 0,gainNode:i,volume:a,loop:s},audio:o};else{if(n.duration<3.5)return;this.currentAudios[e]={config:{startTime:0,pausedAt:void 0,gainNode:i,volume:t},audio:o},setTimeout((()=>{delete this.currentAudios[e]}),1e3*n.duration)}return{source:o,gainNode:i}}{let n=this.currentAudios[e].config.pausedAt||0;o=this.audioContext.createBufferSource(),i=this.currentAudios[e].config.gainNode;const a=gameAssets[e];o.buffer=a,o.loop=s;let r=this.currentAudios[e].config.volume||t;i.gain.value=gameData.isMute?0:r,o.connect(i),i.connect(this.audioContext.destination),o.start(0,n),!0===this.currentAudios[e].config.loop?this.currentAudios[e]={config:{startTime:0,gainNode:i,volume:r,loop:s},audio:o}:!1===this.currentAudios[e].config.loop&&(this.currentAudios[e]={config:{startTime:0,gainNode:i,volume:r},audio:o},setTimeout((()=>{delete this.currentAudios[e]}),1e3*a.duration))}}stopAllCurrentAudios(){for(let e in this.currentAudios)this.currentAudios[e].audio.stop(),delete this.currentAudios[e]}playAnimalSound(e,t,s=.3,i=0,o=!0){let n,a;if(t in this.currentAudios){let r=this.currentAudios[t].config.pausedAt||0;n=this.audioContext.createBufferSource(),a=this.currentAudios[t].config.gainNode,n.buffer=e,n.loop=o;let l=this.currentAudios[t].config.adjustedVolume||s;a.gain.value=gameData.isMute?0:l,n.connect(a),a.connect(this.audioContext.destination),n.start(i,r),this.currentAudios[t]={config:{startTime:i,gainNode:a,volume:l},audio:n}}else{n=this.audioContext.createBufferSource(),a=this.audioContext.createGain(),n.buffer=e,n.loop=o;let r=gameData.isMute?0:s;a.gain.value=r,n.connect(a),a.connect(this.audioContext.destination),n.start(i,0),this.currentAudios[t]={config:{startTime:i,pausedAt:void 0,gainNode:a,volume:r},audio:n}}return{source:n,gainNode:a}}stopAnimalSound(e){if(!(e in this.currentAudios))throw new Error("It is not possible to stop an inexisted audio");{let t=this.currentAudios[e].audio.context.currentTime;this.currentAudios[e].audio.stop(),this.currentAudios[e].config.pausedAt=t,this.isPLaying=!1}}resetContainerToNewScene(e){let t=e.split(" ").map((e=>function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}(e))).join("_");const s=document.getElementById("main");s.innerHTML=" ",t+=" container",s.className=t,new App(this,t)}disposeAudioContext(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}setBackground(e){this.element.style.backgroundImage=`url(${e})`}handlePlayAndPauseBtn(e,t){if(0===t.length)return void this.popUpMessage("Escolha pelo menos uma faixa para tocar!");const s=play_pause_btn.children[0],i=s.classList.contains("fa-play");s.classList.toggle("fa-play",!i),s.classList.toggle("fa-pause",i),play_pause_btn.style.color=i?colors.redDeep_main:colors.blue_main,play_pause_btn.style.borderColor=i?colors.redDeep_main:colors.blue_main,i?(this.chosenAnimalsNameArr.forEach((e=>this.playAnimalSound(gameAssets[e.slot],e.slot,e.volume,e.delay,e.loop))),this.isPLaying=!0):this.chosenAnimalsNameArr.forEach((e=>this.stopAnimalSound(e.slot)))}handleTrashToReset(e){this.isPLaying&&(this.handlePlayAndPauseBtn(e,this.chosenAnimalsNameArr),this.chosenAnimalsNameArr.forEach((e=>{this.stopAnimalSound(e.slot)}))),this.resetSampleBoard(),this.resetSelectedOptions()}controlersSelection(e){e.preventDefault();const t=document.querySelector(".sgh_soundControl_wrapper");let s=e.key,i=document.querySelector(".rowOnFocus"),o=this.chosenAnimalsNameArr.length>=5;switch(s){case"Enter":if(e.preventDefault(),this.optFlag)i&&!o&&i.click(),o&&this.popUpMessage("Numero maximo de escolhas atingido");else if(this.ctrFlag){let s;e.preventDefault(),!t||(s=t.contains(document.activeElement)),s&&document.activeElement.click(),aux++}break;case"Backspace":this.handleTrashToReset();break;case"Escape":this.callHomeScene(App)}}resetCTRFlag(){this.ctrFlag=!1}optionNavigation(e){let t=e.key;const s=document.querySelector(".rowOnFocus"),i=document.querySelectorAll(".sgh_menu_opt").length;let o,n,a=i-1;if("ArrowDown"===t||"ArrowUp"===t)switch(this.resetCTRFlag(),this.optFlag=!0,t){case"ArrowDown":if(e.preventDefault(),s){n=Number(s.getAttribute("index"));let e=(n+1+i)%i,t=document.querySelector(`.sgh_menu_row[index="${e}"]`);t&&t.focus()}else{let e=document.querySelector('.sgh_menu_row[index="0"]');e?e.focus():console.warn("Primeiro elemento NÃO ENCONTRADO !")}break;case"ArrowUp":if(e.preventDefault(),s){n=Number(s.getAttribute("index"));let e=(n-1+i)%i,t=document.querySelector(`.sgh_menu_row[index="${e}"]`);t&&t.focus()}else o=document.querySelector(`.sgh_menu_row[index="${a}"]`),o&&o.focus()}}controlsNavigation(e){let t=e.key;if("Enter"===t&&e.preventDefault(),"ArrowRight"!==t&&"ArrowLeft"!==t)return;"ArrowRight"!==t&&"ArrowLeft"===t||(this.optFlag=!1);let s;const i=document.querySelector(".sgh_soundControl_wrapper");if(i){if(!this.ctrFlag)return i.children[this.initialControlsIndex].focus(),this.ctrFlag=!0,void(this.ctrCurrentIdx=this.initialControlsIndex);switch(t){case"ArrowRight":s=(this.ctrCurrentIdx+1+3)%3,i.children[s].focus(),this.ctrCurrentIdx=s;break;case"ArrowLeft":document.activeElement.blur(),s=(this.ctrCurrentIdx-1+3)%3,i.children[s].focus(),this.ctrCurrentIdx=s}}else console.warn("O elemento '.sgh_soundControl_wrapper' não foi encontrado")}onTableElementFocus(e){const t=document.querySelector(".rowOnFocus");this.chosenAnimalsNameArr.length;t&&t.classList.remove("rowOnFocus"),e.target.classList.add("rowOnFocus"),this.ctrFlag=!1,this.optFlag=!0}onControlsElementFocus(e){this.ctrFlag=!0,this.optFlag=!1}chooseAnimal(e){let t=this.chosenAnimalsNameArr.length>=5;const s=sightsData[this.location.name].samples,i=e.target.textContent.split(" ").map((e=>e.toLocaleLowerCase())).join(" ");let o=Object.values(s).find((e=>e.alt===i));if(this.chosenAnimalsNameArr.some((e=>e.slot===o.soundName)))return void this.removeSpecificAnimal(o,e);if(t)return void this.popUpMessage("O seu número máximo de escolhas foi atingido.","#play_pause_btn",4e3);e.target.classList.add("selected");const n=document.querySelectorAll(".sample_img_wrapper");let{delay:a,volume:r,loop:l}=o,c=this.createNewElement("img","sample_img",`${o.objName}_sample`,o.img_src);c.setAttribute("alt",o.alt);let u=this.randomNumberExcluding(this.chosenContainerIdxArr),m=n[u];m.innerHTML="",m.appendChild(c),this.chosenAnimalsNameArr.push({slot:o.soundName,delay:a,volume:r,loop:l,wrapperIdx:u}),this.updateChoicesInterface(),gameData.isAccess&&(this.textToBeRead.textContent=`O som;${i} foi adicionado a sua música como ${function(e){const t={1:"primeiro",2:"segundo",3:"terceiro",4:"quarto",5:"quinto",6:"sexto",7:"sétimo",8:"oitavo",9:"nono",10:"décimo",11:"décimo primeiro",12:"décimo segundo",13:"décimo terceiro",14:"décimo quarto",15:"décimo quinto",16:"décimo sexto",17:"décimo sétimo",18:"décimo oitavo",19:"décimo nono",20:"vigésimo",30:"trigésimo",40:"quadragésimo",50:"quinquagésimo",60:"sexagésimo",70:"septuagésimo",80:"octogésimo",90:"nonagésimo",100:"centésimo"};if(t[e])return t[e];if(e>20&&e<100){let s=e%10;return`${t[10*Math.floor(e/10)]} ${t[s]}`}return`${e}º`}(this.chosenAnimalsNameArr.length)} som`),e.target.classList.add("rowOnFocus")}removeSpecificAnimal(e,t){let s=document.querySelector(`#${e.objName}_sample`),i=this.chosenAnimalsNameArr.findIndex((t=>t.slot===e.soundName)),o=this.chosenContainerIdxArr.findIndex((e=>e==this.chosenAnimalsNameArr[i].wrapperIdx));s.remove(),-1!==i&&this.chosenAnimalsNameArr.splice(i,1),-1!==o&&this.chosenContainerIdxArr.splice(o,1),gameData.isAccess&&(this.textToBeRead.textContent=`O som;${e.objName} foi removido da sua música. Restam ${this.choicesAmount-this.chosenAnimalsNameArr.length} escolhas disponíveis`),t.target.classList.remove("selected"),this.updateChoicesInterface()}updateChoicesInterface(){const e=document.querySelector(".sgh_choices_made"),t=document.getElementById("sgh_choices_control");let s=this.chosenAnimalsNameArr.length;e&&t&&(e.textContent=s,e.style.color=s>=5?colors.red_negative:colors.white,t.setAttribute("title",`Voce pode escolher ${this.choicesAmount-s} opções de um total de ${this.choicesAmount}`),t.setAttribute("aria-label",`Voce pode escolher ${this.choicesAmount-s} opções de um total de ${this.choicesAmount}`))}randomNumberExcluding(e){let t;do{t=Math.floor(20*Math.random())+1}while(5===t||10===t||e.includes(t-1));return e.push(t-1),t-1}removeEventsRegistered(){const e=document,t=e.getElementById("play_pause_btn"),s=e.getElementById("trash_btn"),i=e.getElementById("home_btn"),o=e.querySelectorAll(".sgh_menu_row");s.removeEventListener("click",(()=>this.handleTrashToReset())),t.removeEventListener("click",(e=>this.handlePlayAndPauseBtn(e,this.chosenAnimalsNameArr))),i.removeEventListener("click",(e=>this.callHomeScene(App))),e.removeEventListener("keydown",this.handleKeyDown),e.removeEventListener("keyup",this.handleControlersSelection),o&&o.forEach(((e,t)=>{e.removeEventListener("focus",(e=>this.onTableElementFocus(e,t))),e.removeEventListener("click",(e=>this.chooseAnimal(e,t)))}))}popUpMessage(e,t,s=2500,i=!0,o=!0,n=!1){const a=document.getElementById("popUpMessage"),r=document.querySelector(".popupText"),l=document.querySelector(t);let c=a.style.display;console.log(gameData.isAccess),gameData.isAccess&&(o=!1),a?.classList.toggle("animated",!a.classList.contains("animated")),"flex"!=c&&(a.style.display="flex"),a.removeAttribute("hidden"),i&&(a.style.opacity=1),n||(r.textContent=""),r.textContent=e,console.log(gameData.isAccess),gameData.isAccess&&(r.setAttribute("tabindex",1),r.focus()),o||setTimeout((()=>{a.style.opacity=0,a.style.display="none",r.removeAttribute("tabindex")}),5e3),t&&s&&setTimeout((()=>l.focus()),s+100)}callHomeScene(e){this.removeEventsRegistered(),this.stopAllCurrentAudios(),this.element.remove(),new e(!0)}resetSelectedOptions(){document.querySelectorAll(".sgh_menu_row.selected").forEach((e=>{e.classList.remove("selected")}))}}function capitalizeStr(e){if(e&&"string"==typeof e)return e.charAt(0).toLocaleUpperCase()+e.slice(1).toLocaleLowerCase()}export{Sights};