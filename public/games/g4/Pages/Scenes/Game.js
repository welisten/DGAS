import{gameData}from"../../Constants/gameData.js";import{colors}from"../../Constants/Colors.js";import{Sights}from"./Sights.js";import{gainNode,audioContext,currentAudios}from"./../../Js/script.js";import{audioDataArray}from"../../Constants/songsData.js";class App{constructor(e=!1){this.element=document.querySelector("#game_container"),this.element.classList.add("hm"),this.currentAudios=currentAudios,this.audioContext=audioContext,this.gainNode=gainNode,this.isInitMsgAlreadySkipped=e,document.title="Guapimirim Áudio Estúdio",gameData.mainScene="Game",this.currentIndex=0,this.handleIntroSkip=this.skipIntro.bind(this),this.handleChooseOption=this.chooseOpt.bind(this),this.handleNewSceneCalling=this.callNewScene.bind(this),this.handleOptionsFocus=this.optionOnFocus.bind(this),gameData.isMute||(this.gainNode.gain.value=0),this.start()}start(){this.buildContainer(),this.setContainersElms(),this.playGameAudio("positiveBlipEffect",1,!1),setTimeout((()=>{if(this.stopAllCurrentAudios(),this.playGameAudio("mainTheme",.5,!0),gameData.isClickable=!0,gameData.isAccess){let e;this.isInitMsgAlreadySkipped?(e=document.querySelector(".invitation"),setTimeout((()=>e.focus()),1500)):(e=document.querySelector(".hm_h1"),e.focus())}}),1e3)}buildContainer(){(()=>{let e,t,i;this.element.classList.remove("inactive"),e=window.screen.width>2e3?.4*window.screen.width:window.screen.width>1500?.65*window.screen.width:.6*window.screen.width,t=Math.floor(e),i=.7*window.innerHeight,this.element.style.width=`${t}px`,this.element.style.height=`${i}px`})();const e=this.element,t=this.createNewElement("div","container","main"),i=this.createNewElement("div","hm_bgImgContainer"),n=this.createNewElement("img","studioImg",void 0,"./../Assets/imgs/studio.png"),s=this.createNewElement("div","hm_sampleTable"),o=this.createNewElement("img","lamp","hm_lamp","./../Assets/imgs/lamp.png"),a=this.createNewElement("h2","invitation"),r=this.createNewElement("div","hm_menu"),l=this.createNewElement("h3","menuTitle","hm_menuTitle"),d=this.createNewElement("ul","menuBody"),u=this.createNewElement("span","mn_row"),c=this.createNewElement("l1","mn_option selected btn"),m=this.createNewElement("td","mn_opt_icon"),h=this.createNewElement("img","options_kitty_iMG","options_kitty_iMG","./../Assets/imgs/kitty.png"),p=this.createNewElement("span","mn_row"),A=this.createNewElement("td","mn_option btn");this.buildInitialMessage(this.isInitMsgAlreadySkipped,t),o.setAttribute("alt","Lampada de teto"),h.setAttribute("alt","Gatinho"),o.setAttribute("inert",""),m.setAttribute("inert",""),a.textContent="Vamos fazer um som ?",l.textContent="Escolha uma base:",c.textContent="Rio soberbo",A.textContent="Centro",a.setAttribute("tabindex",4),a.setAttribute("role","paragraph"),l.setAttribute("tabindex",5),l.setAttribute("aria-label","Escolha uma base dentre as opções do menu"),l.setAttribute("role","paragraph"),r.setAttribute("aria-labelledly","hm_menuTitle"),c.setAttribute("tabindex",6),c.setAttribute("role","menuitem"),c.setAttribute("title","Clique para escolher a opção de base musical"),A.setAttribute("tabindex",7),A.setAttribute("role","menuitem"),A.setAttribute("title","Clique para escolher a opção de base musical"),this.isInitMsgAlreadySkipped&&a.setAttribute("hm-initialFocus",""),i.appendChild(n),m.appendChild(h),u.append(c,m),p.append(A),d.append(u,p),r.append(l,d),s.append(o,a,r),t.append(i,s),e.appendChild(t)}setContainersElms(){const e=document.querySelectorAll(".mn_option");if(this.isInitMsgAlreadySkipped){document.querySelector(".hm_bgImgContainer").style.left="2%"}else{const e=document.querySelector(".hm_msg_skip");document.addEventListener("keydown",this.handleIntroSkip),e.addEventListener("click",this.handleIntroSkip)}e.forEach((e=>{e.addEventListener("click",this.handleNewSceneCalling),e.addEventListener("focus",this.handleOptionsFocus)}))}createNewElement(e,t=void 0,i=void 0,n=void 0){const s=document.createElement(e);if(t){let e=t.split(" ");for(let t=0;t<e.length;t++)s.classList.add(e[t])}return i&&s.setAttribute("id",i),n&&s.setAttribute("src",n),s}buildInitialMessage(e,t){if(this.isInitMsgAlreadySkipped)t.classList.add("skipped"),setTimeout((()=>{const e=document.querySelector(".hm_sampleTable");e&&(e.style.opacity=1)}),500),this.playGameAudio("btn_select",1,!1),document.addEventListener("keydown",this.handleChooseOption);else{const e=this.createNewElement("div","hm_initialMessage","hm_initialMessage"),i=this.createNewElement("h1","hm_h1"),n=this.createNewElement("span","hm_welcomeTxt"),s=this.createNewElement("span","hm_gameNameTxt"),o=this.createNewElement("p","hm_message"),a=this.createNewElement("button","hm_msg_skip"),r="Olá Amiguinho!<br>Aqui você vai descobrir muitos sons incríveis! Cada clique pode trazer uma surpresa. será o som de um animal? De um instrumento? Ou de algo que você conhece muito bem? <br>Este jogo foi feito para todos! Se você não pode ver tão bem, não se preocupe! Os sons vão te guiar nessa aventura.<br>Pronto para começar? Então abra bem os ouvidos e divirta-se!";n.textContent="Bemvindos ao",s.textContent="Sons do Rio.",o.innerHTML=r,a.textContent="Pular >",i.append(n,s),i.setAttribute("tabindex",1),i.setAttribute("hm-initialFocus",""),i.setAttribute("role","paragraph"),o.setAttribute("tabindex",2),a.setAttribute("tabindex",3),a.setAttribute("aria-label","pular introdução"),a.setAttribute("title","Clique para pular a introdução"),e.append(i,o,a),t.appendChild(e)}}optionOnFocus(e){const t=e.target,i=[...document.querySelectorAll(".mn_option")],n=document.querySelector(".mn_opt_icon"),s=n.parentElement,o=i.indexOf(t);i.forEach((e=>e.classList.remove("selected"))),t.classList.add("selected"),s.removeChild(n),t.parentElement.append(n),this.currentIndex=o}chooseOpt(e){const t=document.querySelectorAll(".mn_option"),i=document.querySelectorAll(".mn_row"),n=document.querySelector(".mn_opt_icon");let s=t.length;"ArrowUp"!==e.key&&"ArrowDown"!==e.key||(t[this.currentIndex].classList.remove("selected"),i[this.currentIndex].removeChild(n),"ArrowUp"===e.key?this.currentIndex=(this.currentIndex-1+s)%s:this.currentIndex=(this.currentIndex+1+s)%s,t[this.currentIndex].classList.add("selected"),i[this.currentIndex].appendChild(n),this.playGameAudio("btn_select",1,!1),gameData.isAccess&&t[this.currentIndex].focus()),"Enter"===e.key&&t[this.currentIndex].click()}skipIntro(e){const t=document.querySelector("#main"),i=document.querySelector(".hm_msg_skip"),n=document.getElementById("info"),s=document.querySelector(".hm_initialMessage"),o=document.querySelector(".hm_sampleTable");if(n.classList.contains("active"))return;let a="keydown"===e.type&&("Escape"===e.key||"Enter"===e.key)||"click"===e.type;if(!t.classList.contains("skipped")&&a){e.preventDefault();const n=document.querySelector(".hm_bgImgContainer"),a=document.querySelector("[hm-initialFocus]");document.removeEventListener("keydown",this.handleIntroSkip),i.removeEventListener("click",this.handleIntroSkip),s.style.opacity=0,n.style.left="2%",a&&(a.removeAttribute("hm-initialFocus"),document.querySelector(".invitation").setAttribute("hm-initialFocus","")),t.classList.add("skipped"),setTimeout((()=>{o.style.opacity=1,gameData.isAccess&&document.querySelector(".invitation").focus()}),500),this.playGameAudio("btn_select",1,!1),document.addEventListener("keydown",this.handleChooseOption)}}playGameAudio(e,t=1,i=!1){let n,s;if(!(e in this.currentAudios)){s=this.audioContext.createBufferSource(),n=this.audioContext.createGain();const o=gameAssets[e];s.buffer=o,s.loop=i;let a=audioDataArray.find((t=>t.name===e)).volume||t;if(n.gain.value=gameData.isMute?0:a,s.connect(n),n.connect(this.audioContext.destination),s.start(0,0),!0===i)this.currentAudios[e]={config:{startTime:0,pausedAt:void 0,gainNode:n,volume:a,loop:i},audio:s};else{if(o.duration<3.5)return;this.currentAudios[e]={config:{startTime:0,pausedAt:void 0,gainNode:n,volume:t},audio:s},setTimeout((()=>{delete this.currentAudios[e]}),1e3*o.duration)}return{source:s,gainNode:n}}{let o=this.currentAudios[e].config.pausedAt||0;s=this.audioContext.createBufferSource(),n=this.currentAudios[e].config.gainNode;const a=gameAssets[e];s.buffer=a,s.loop=i;let r=this.currentAudios[e].config.volume||t;n.gain.value=gameData.isMute?0:r,s.connect(n),n.connect(this.audioContext.destination),s.start(0,o),!0===this.currentAudios[e].config.loop?this.currentAudios[e]={config:{startTime:0,gainNode:n,volume:r,loop:i},audio:s}:!1===this.currentAudios[e].config.loop&&(this.currentAudios[e]={config:{startTime:0,gainNode:n,volume:r},audio:s},setTimeout((()=>{delete this.currentAudios[e]}),1e3*a.duration))}}stopAllCurrentAudios(){for(let e in this.currentAudios)this.currentAudios[e].audio.stop(),delete this.currentAudios[e]}removeAllElementsEvents(){const e=document.querySelector(".hm_msg_skip"),t=document.querySelectorAll(".mn_option");document.removeEventListener("keydown",this.handleIntroSkip),e?.removeEventListener("click",this.handleIntroSkip),document.removeEventListener("keydown",this.handleChooseOption),t?.forEach((e=>{e.removeEventListener("click",this.handleNewSceneCalling)})),this.removeBtnEvents()}callNewScene=e=>{this.stopAllCurrentAudios(),this.removeAllElementsEvents(),this.resetContainerToNewScene(e.target.textContent)};resetContainerToNewScene(e){let t=e.split(" ").map((e=>function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}(e))).join("_");const i=document.getElementById("main");i.innerHTML=" ",t+=" container",i.className=t,new Sights(t.split(" ")[0],this.currentAudios)}getImage(e){return gameAssets[e]}setBtns(e=document){let t=e.querySelectorAll(".btn"),i=!1;t.forEach((t=>{t.addEventListener("mouseenter",(()=>{i||(i=!i,e===document&&this.playGameAudio("btn_select"))})),t.addEventListener("mouseout",(()=>{i=!1}))}))}removeBtnEvents(e=document){let t=e.querySelectorAll(".btn"),i=!1;t.forEach((t=>{t.removeEventListener("mouseenter",(()=>{i||(i=!i,e===document&&this.playGameAudio("btn_select"))})),t.removeEventListener("mouseout",(()=>{i=!1}))}))}popUpMessage(e,t,i=2500,n=!0,s=!0,o=!1){const a=document.getElementById("popUpMessage"),r=document.querySelector(".popupText"),l=document.querySelector(t);let d=a.style.display;a?.classList.toggle("animated",!a.classList.contains("animated")),"flex"!=d&&(a.style.display="flex"),a.removeAttribute("hidden"),n&&(a.style.opacity=1),o||(r.textContent=""),r.setAttribute("tabindex",1),r.textContent=e,!gameData.isAccess||r.focus(),s||setTimeout((()=>{a.style.opacity=0,a.style.display="none"}),1500),t&&i&&setTimeout((()=>l.focus()),i+100)}disposeAudioContext(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}export{App};