import{gameData}from"../../Constants/gameData.js";import{sightData}from"../../Constants/sightsData.js";class Sights{constructor(e,t){this.game=e,this.location={name:t},this.location.animals=void 0,this.element=document.querySelector("#game_container"),this.element.classList.add("j4-sgt"),this.element.classList.add("sights"),this.currentSpot=void 0,this.start();const a=e=>{if(e&&"string"==typeof e)return e.charAt(0).toLocaleUpperCase()+e.slice(1).toLocaleLowerCase()};document.title=a(t),gameData.mainScene=a(t)}start(){this.setAnimals(),this.buildContainer(),this.setContainerElements(),gameData.isClickable=!0,gameData.isAccess&&this.game.readText(sightData[this.location.name].descri,null,!0)}setAnimals(){if(!sightData[this.location.name])throw new Error("location parameter is incorrect.");this.location.animals=sightData[this.location.name].animals}buildContainer(){const e=document.querySelector(".j4-bg-bg"),t=this.element.querySelector("#main"),a=this.game.createNewElement("div","sgt-container container"),s=this.game.createNewElement("div","stg-card container","stg-card"),i=this.game.createNewElement("div","stg-card-title"),n=this.game.createNewElement("div","stg-card-body");if(s.append(i,n),s.style.display="none",e.style.backgroundImage=`url(../Assets/imgs/general/${sightData[this.location.name].background})`,this.location.animals){let e,t=this.location.animals.length;for(let s=0;s<t;s++)e=this.game.createNewElement("p","spot btn"),e.setAttribute("tabindex",`${s+17}`),e.setAttribute("aria-label",`O ${s+1}º animal se esconde aqui.`),e.setAttribute("aria-live","assertive"),e.setAttribute("title",`O ${s+1}º animal se esconde aqui.`),e.style.left=`${sightData[this.location.name].coordinates[s].x}%`,e.style.bottom=`${sightData[this.location.name].coordinates[s].y}%`,a.appendChild(e)}a.appendChild(s),t.append(a),this.game.playAudio(gameAssets.nature_ambience,"nature_ambience",.3,!0)}setContainerElements(){const e=document.querySelectorAll(".spot"),t=document.querySelector(".j4-bg-bg"),a=document.querySelector(".stg-card"),s=document.querySelector(".stg-card-title"),i=document.querySelector(".stg-card-body");let n,o,r,c,l;e.forEach(((d,m)=>{d.addEventListener("click",(u=>{this.currentSpot=u.target,gameData.isClickable=!1,this.game.readText(`${this.location.animals[m].nome}`),t.classList.add("blur"),e.forEach((e=>e.style.display="none")),a.style.display="flex",i.innerHTML="",s.innerHTML="",n=this.game.getImage(this.location.animals[m].key),n.setAttribute("class","cardImage"),n.setAttribute("tabindex","1"),n.setAttribute("aria-label","veja uma foto"),n.setAttribute("alt",this.location.animals[m].alt),l=this.game.createNewElement("button","card-close btn","cardCloseBtn"),l.innerHTML='<i class="fa-solid fa-xmark"></i>',l.setAttribute("tabindex","4"),l.setAttribute("aria-label","Fechar cartão"),o=this.game.createNewElement("p","card-name-text");let g=this.location.animals[m].nome;o.innerHTML=g,r=this.game.createNewElement("p","card-descri-text"),r.innerHTML=this.location.animals[m].descri,r.setAttribute("tabindex","3"),c=this.game.createNewElement("button","card-play btn","cardBtn"),c.innerHTML='<i class="fa-solid fa-play"></i>',c.setAttribute("tabindex","2"),c.setAttribute("aria-label","descubra o som !"),s.append(n),i.append(o,r,c),a.appendChild(l),setTimeout((()=>n.focus()),1e3),textFit(r),textFit(o);for(let e=0;e<4;e++){let t=this.game.getImage(`static-cloud-${e+1}`);t.classList.add("static-cloud"),t.classList.add(`sc${e+1}`),t.setAttribute("alt","nuvem"),a.appendChild(t)}this.game.playAudio(gameAssets.positiveBlipEffect,void 0,.1),c.addEventListener("click",(()=>{gameData.isPlayingSound?(gameData.isPlayingSound=!1,c.innerHTML='<i class="fa-solid fa-play"></i>',this.stopAnimalSound(this.location.animals[m].sound)):(this.playAnimalSound(gameAssets[this.location.animals[m].sound],this.location.animals[m].sound),gameData.isPlayingSound=!0,c.innerHTML='<i class="fa-solid fa-pause"></i>')})),l.addEventListener("click",(s=>{t.classList.remove("blur"),e.forEach((e=>e.style.display="block")),a.style.display="none",this.game.stopCurrentAudio(),gameData.isClickable=!0,this.game.playAudio(gameAssets.nature_ambience,"nature_ambience",.3,!0),this.currentSpot.focus()}));const h=e=>{let a,s,i;a=t.classList.contains("blur")&&!t.parentNode.classList.contains("blur"),s=document.querySelector("#stg-card"),i=document.querySelectorAll(".spot"),"Escape"===e.key&&a&&(t.classList.remove("blur"),s.style.display="none",i.forEach((e=>e.style.display="block")),this.game.stopCurrentAudio(),gameData.isClickable=!0,this.game.playAudio(gameAssets.nature_ambience,"nature_ambience",.3,!0),this.currentSpot.focus())};s.addEventListener("click",(()=>{const e=this.element.querySelector("#main"),a=document.querySelector("#stg-card");n.classList.remove("cardImage"),n.classList.add("cardImg"),t.parentNode.classList.add("blur"),a.classList.add("blur"),e.append(n);const i=e=>{let i=a.classList.contains("blur");"Escape"===e.key&&i?setTimeout((()=>{n.remove(),s.append(n),t.parentNode.classList.remove("blur"),a.classList.remove("blur"),n.classList.remove("cardImg"),n.classList.add("cardImage"),c.focus(),this.game.events.forEach((e=>document.removeEventListener(e.event,e.func))),document.addEventListener("keydown",h),this.game.events.push({func:h,elem:document,event:"keydown"})}),100):"Tab"===e.key&&e.preventDefault()};document.addEventListener("keydown",i),this.game.events.push({func:i,elem:document,event:"keydown"}),document.addEventListener("mousedown",(e=>{a.classList.contains("blur")&&(n.contains(e.target)||(n.remove(),s.append(n),t.parentNode.classList.remove("blur"),a.classList.remove("blur"),n.classList.remove("cardImg"),n.classList.add("cardImage")))}))})),document.addEventListener("keydown",h),this.game.events.push({func:h,elem:document,event:"keydown"}),d.addEventListener("mouseover",(()=>{this.game.playAudio(gameAssets.btn_select,"",.3)}))}))}))}playAnimalSound(e,t){let a,s;if(t in this.game.currentAudio){let i=this.game.currentAudio[t].config.pausedAt||0;a=this.game.audioContext.createBufferSource(),s=this.game.currentAudio[t].config.gainNode,a.buffer=e,a.loop=!0;let n=!0===gameData.isMute?0:1;s.gain.value=n,a.connect(s),s.connect(this.game.audioContext.destination),a.start(0,i),this.game.currentAudio[t]={config:{startTime:0,pausedAt:void 0,gainNode:s,volume:n}},this.game.currentAudio[t].audio=a}else{a=this.game.audioContext.createBufferSource(),s=this.game.audioContext.createGain(),a.buffer=e,a.loop=!0;let i=!0===gameData.isMute?0:1;s.gain.value=i,a.connect(s),s.connect(this.game.audioContext.destination),a.start(0,0),this.game.currentAudio[t]={config:{startTime:0,pausedAt:void 0,gainNode:s,volume:i}},this.game.currentAudio[t].audio=a}return{source:a,gainNode:s}}stopAnimalSound(e){if(!(e in this.game.currentAudio))throw new Error("It is not possible to stop an inexisted audio");{let t=this.game.currentAudio[e].audio.context.currentTime;this.game.currentAudio[e].audio.stop(),this.game.currentAudio[e].config.pausedAt=t}}}export{Sights};