import{containerGame_width,containerGame_height,mapMain_scale}from"../Consts/Sizes.js";import{lifeBar}from"../Consts/SpriteSheets.js";import{uiImages}from"../Consts/ImagesKeys.js";import{level_data}from"../Consts/LevelStatesObj.js";import{userIterfaceState,gameState,playerState}from"../Consts/GameStateObj.js";import{lifeBart_animationsKey}from"../Consts/Animations.js";let timer_UI=level_data.timer,queue=[];export default class GameBackground extends Phaser.Scene{init(){this.auxText="",this.auxLife=0,this.currentIndex=0,this.controlTextObj={interfaceText_stt:"paused"},this.arrows=[]}create(){this.screenFrame=this.add.rectangle(10,10,containerGame_width-20,containerGame_height-20,"0xffffff",1).setOrigin(0).setStrokeStyle(3,"0xffffff",1).isFilled=!1,this.heart_1=this.add.sprite(20,20,lifeBar.lifeBar_key,0).setOrigin(0).setScale(.5),this.heart_2=this.add.sprite(50,20,lifeBar.lifeBar_key,0).setOrigin(0).setScale(.5),this.heart_3=this.add.sprite(80,20,lifeBar.lifeBar_key,0).setOrigin(0).setScale(.5),this.timerGraficFrame=this.add.graphics(),this.timerGraficFrame.fillStyle(16777215,.5);const e=containerGame_width-118;this.timerGraficFrame.fillRoundedRect(e,20,100,50,20),this.clock=this.add.image(containerGame_width-115,27,uiImages.timer.key).setOrigin(0).setScale(1).setTintFill("0x000000"),this.timer=this.add.text(containerGame_width-85,27,timer_UI<10?`0${timer_UI}`:`${timer_UI}`,{fontSize:35,color:"0x000000"}).setOrigin(0),this.dialogBox=this.add.image(containerGame_width/2,containerGame_height-70,uiImages.dialogBox.key).setOrigin(.5).setScale(1.7,.8),this.dialogBox.setAlpha(0),this.textOfDialogBox=this.add.text(containerGame_width/2,containerGame_height-110,"",{fontSize:24,color:"0xffffff",wordWrap:{width:1.7*this.dialogBox.width-40,useAdvancedWrap:!0},align:"center"}).setOrigin(.5,0),this.textOfDialogBox.setLineSpacing(6);this.CityMap_info_popUp=this.add.image(containerGame_width/2,-244,uiImages.cityMap_Sign.key).setOrigin(.5,0).setAlpha(0).setDepth(10),this.cityMap_info_in=this.tweens.add({targets:this.CityMap_info_popUp,y:0,duration:750,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.cityMap_info_out=this.tweens.add({targets:this.CityMap_info_popUp,y:-244,duration:750,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.developer_sign=this.add.image(containerGame_width/2,containerGame_height/2,uiImages.developer.key).setOrigin(.5).setScale(.8).setAlpha(0),this.developer_sign_in=this.tweens.add({targets:this.developer_sign,alpha:1,duration:500,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.developer_sign_out=this.tweens.add({targets:this.developer_sign,alpha:0,duration:500,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.cityMap_map=this.add.image(containerGame_width/2,containerGame_height/2,uiImages.cityMap_Map.key).setOrigin(.5).setScale(.55).setAlpha(0),this.cityMap_map_in=this.tweens.add({targets:this.cityMap_map,alpha:1,duration:500,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.cityMap_map_out=this.tweens.add({targets:this.cityMap_map,alpha:0,duration:250,ease:"Linear",repeat:0,paused:!0,persist:!0}),this.cursor=this.input.keyboard.createCursorKeys()}update(){this.handel_timerEl(timer_UI,level_data),this.handlePlayerLife(playerState.life),this.check_Add_textToQueue(userIterfaceState.text),this.handel_Queue(queue,this.controlTextObj.interfaceText_stt),gameState.isTopInformationAble&&(this.showTopInformation(gameState.topInformationType),gameState.isTopInformationAble=!1),gameState.isGuapimirimSignAble&&(this.cityMap_info_out.play(),this.bringMapToScrean(),gameState.isGuapimirimSignAble=!1),gameState.isGuapimirimSignVisible&&this.cursor.space.isDown&&(this.cityMap_map_out.play(),gameState.isGuapimirimSignVisible=!1,gameState.isPlayerAbleToMove=!0,gameState.isGuapimirimSignAble=!1,gameState.isTopInformationAble=!1,this.time.addEvent({delay:2e3,callback:()=>gameState.counter_cityMap=0,loop:!1})),gameState.isDevelopersSignOn&&this.cursor.space.isDown&&(this.developer_sign_out.play(),this.heart_1.setAlpha(1),this.heart_2.setAlpha(1),this.heart_3.setAlpha(1),this.clock.setAlpha(1),this.timer.setAlpha(1),this.timerGraficFrame.setAlpha(1),gameState.developerSign_step++),gameState.isExploreAble&&this.handleExplore(),gameState.isDevelopersSignAble&&this.handleDevelopersSign()}handleDevelopersSign(){gameState.isDevelopersSignOn||(this.developer_sign_in.play(),this.heart_1.setAlpha(0),this.heart_2.setAlpha(0),this.heart_3.setAlpha(0),this.clock.setAlpha(0),this.timer.setAlpha(0),this.timerGraficFrame.setAlpha(0),gameState.isDevelopersSignOn=!0)}handleExplore(){if(gameState.explore){const e=this.add.graphics(),t=.45*containerGame_width,i=.1*containerGame_height;e.fillStyle(16777215,.5),e.fillRect(containerGame_width/2-t/2,.1*containerGame_height,t,i);const a=this.add.graphics();a.lineStyle(3,65280),a.strokeRect(containerGame_width/2-t/2,.1*containerGame_height,t,i);const s=this.add.text(containerGame_width/2,.15*containerGame_height,"Modo Explorar Ativado",{fill:"0x000000",fontStyle:"bold",fontWeight:"bold",fontSize:.03*containerGame_width}).setOrigin(.5);this.time.addEvent({delay:1500,callback:()=>{e.destroy(),a.destroy(),s.text=""},loop:!1}),gameState.isExploreAble=!1}else{const e=this.add.graphics(),t=.5*containerGame_width,i=.1*containerGame_height;e.fillStyle(16777215,.5),e.fillRect(containerGame_width/2-t/2,.1*containerGame_height,t,i);const a=this.add.graphics();a.lineStyle(3,267386880),a.strokeRect(containerGame_width/2-t/2,.1*containerGame_height,t,i);const s=this.add.text(containerGame_width/2,.15*containerGame_height,"Modo Explorar Desativado",{fill:"0x000000",fontStyle:"bold",fontWeight:"bold",fontSize:.03*containerGame_width}).setOrigin(.5);this.time.addEvent({delay:1500,callback:()=>{e.destroy(),a.destroy(),s.text=""},loop:!1}),gameState.isExploreAble=!1}}handlePlayerLife(e){if(this.auxLife!=e){switch(playerState.life/.5){case 6:this.heart_1.play({key:lifeBart_animationsKey.heart_full.key,repeat:0},!0),this.heart_2.play({key:lifeBart_animationsKey.heart_full.key,repeat:0},!0),this.heart_3.play({key:lifeBart_animationsKey.heart_full.key,repeat:0},!0);break;case 5:this.heart_3.play({key:lifeBart_animationsKey.heart_half.key,repeat:0},!0);break;case 4:this.heart_3.play({key:lifeBart_animationsKey.heart_empty.key,repeat:0},!0);break;case 3:this.heart_2.play({key:lifeBart_animationsKey.heart_half.key,repeat:0},!0);break;case 2:this.heart_2.play({key:lifeBart_animationsKey.heart_empty.key,repeat:0},!0);break;case 1:this.heart_1.play({key:lifeBart_animationsKey.heart_half.key,repeat:0},!0);break;case 0:this.heart_1.play({key:lifeBart_animationsKey.heart_empty.key,repeat:0},!0)}this.auxLife=e}}showTopInformation(e){"CityMap"==e&&(gameState.isPlayerAbleToMove=!1,this.CityMap_info_popUp.setAlpha(1),this.cityMap_info_in.play(),gameState.isTopInformationVisible=!0,gameState.topInformationType="",this.time.addEvent({delay:2e3,callback:()=>{gameState.isGuapimirimSignVisible||(this.cityMap_info_out.play(),this.time.addEvent({delay:3e3,callback:()=>gameState.counter_cityMap=0,loop:!1})),gameState.isTopInformationVisible=!1,gameState.isGuapimirimSignAble=!1,gameState.isPlayerAbleToMove=!0}}))}bringMapToScrean(){gameState.isTopInformationVisible=!1,gameState.isPlayerAbleToMove=!1,this.cityMap_map_in.play(),this.time.addEvent({delay:250,callback:()=>gameState.isGuapimirimSignVisible=!0,loop:!1})}check_Add_textToQueue(e){e&&this.auxText!=e&&(this.auxText=e,this.addToQueue(queue,e))}handel_Queue(e,t){let i="paused"==t;e[0]&&i&&(this.currentIndex=0,this.displayElement(this.dialogBox),this.writeText(e[e.length-1][0]),this.textOfDialogBox.setAlign(e[e.length-1][1]))}writeText(e){let t=this.separeteStringFromdirection(e),i=[];t.indexsArr.length>0&&(i=t.indexsArr);let a=[];for(let t of i){let i=e.indexOf("]",t);a.push(e.slice(t,i+1))}let s=(e=t.string).length;this.controlTextObj.interfaceText_stt="writing",this.displayElement(this.dialogBox),this.displayElement(this.textOfDialogBox);let r=0,n=0,h=(containerGame_width-this.dialogBox.width)/2-10,o=this.textOfDialogBox.y-5;this.typewriter=this.time.addEvent({delay:50,callback:()=>{if(this.controlTextVelocity(e),this.handle_endOfString(this.currentIndex,s),i.length>0&&r<i.length){let e=0==i[r]?i[r]:i[r]-n,t=20*mapMain_scale;if(this.currentIndex==e)switch(a[r]){case"[up]":this.arrows.push(this.add.sprite(h,o,uiImages.arrows.up.key).setScale(.18).setOrigin(0)),o+=t,n+=a[r].length,r++;break;case"[down]":this.arrows.push(this.add.sprite(h,o,uiImages.arrows.down.key).setScale(.25).setOrigin(0)),o+=t,n+=a[r].length,r++;break;case"[left]":this.arrows.push(this.add.sprite(h,o,uiImages.arrows.left.key).setScale(.25).setOrigin(0)),o+=t,n+=a[r].length,r++;break;case"[right]":this.arrows.push(this.add.sprite(h,o,uiImages.arrows.right.key).setScale(.25).setOrigin(0)),o+=t,n+=a[r].length,r++}}this.textOfDialogBox.text+=e[this.currentIndex],this.currentIndex++},loop:!0})}separeteStringFromdirection(e){let t=[];if(-1!==e.indexOf("[")){let i=-1,a=this.countAmountOfOccurrences("[",e);const s=/\[(up|down|left|right)\]/;for(let s=0;s<a;s++)i=e.indexOf("[",i+1),t.push(i);for(let t=0;t<a;t++)e=e.replace(s,"")}return{string:e,indexsArr:t}}countAmountOfOccurrences(e,t){return t.split(e).length-1}handle_endOfString(e,t){e>=t-1&&(this.typewriter.delay=1e3,this.removeFromQueue(queue),this.time.removeEvent(this.typewriter),this.time.addEvent({delay:500,callback:()=>{this.arrows.forEach((e=>{e.destroy(),e.setAlpha(0),this.hideElement(e)})),this.dialogBox.setAlpha(1),this.textOfDialogBox.setAlpha(1)},loop:!1}),this.time.addEvent({delay:1e3,callback:()=>{this.controlTextObj.interfaceText_stt="paused",this.currentIndex=0,this.textOfDialogBox.text=""},loop:!1}),queue[0]||(this.hideElement(this.dialogBox),this.hideElement(this.textOfDialogBox)))}controlTextVelocity(e){switch(e[this.currentIndex]){case".":case"!":this.typewriter.delay=1e3;break;default:this.typewriter.delay=50}}addToQueue(e,t,i="center"){e.push([t,i])}removeFromQueue(e){if(e[0]){return e.shift()}}handel_timerEl(e,t){e!=t.timer&&t.running&&(e=t.timer,this.timer.setText(e<10?`0${e}`:`${e}`))}displayElement(e){let t=e.alpha;if(0==t){let i=this.time.addEvent({delay:50,callback:()=>{if(t>=1)return e.setAlpha(1),void this.time.removeEvent(i);t+=.1,e.setAlpha(t)},loop:!0})}}hideElement(e){let t=e.alpha;if(1==t){let i=this.time.addEvent({delay:50,callback:()=>{if(t<=0)return e.setAlpha(0),void this.time.removeEvent(i);t-=.1,e.setAlpha(t)},loop:!0})}}}const addToUIQueue=(e,t)=>GameBackground.prototype.addToQueue(queue,e,t);export{GameBackground,queue,addToUIQueue};