import{mainUserInterface}from"../Consts/SceneKeys.js";import{mapL1_key,l1_tilesetObjConfig,l1_layers_ID,objectsLayers_keys}from"../Consts/MapKeys.js";import{l1Map_scale,l1Map_height,l1Map_width,transitionFadeDuration,containerGame_height}from"../Consts/Sizes.js";import{userCharacter_objConfig}from"../Consts/CharacterKeys.js";import{level1_delayMapScrolling,level1_SpeedMapScrolling,character_AnimationFrameRate,stemDelay}from"../Consts/Difficulty.js";import{userCharacter_animationsKey,lifeBart_animationsKey}from"../Consts/Animations.js";import{stem,lifeBar}from"../Consts/SpriteSheets.js";import{level1Songs}from"../Consts/SongsKey.js";import{level_data,levelStatesObj}from"../Consts/LevelStatesObj.js";import{playerState,gameState}from"../Consts/GameStateObj.js";import{colors}from"../Consts/Colors.js";const loadedChunks=new Set,arrayChunks=new Array,tileArray=new Array,chunk_size=63,tile_size=16;let lastChunkY=null,aux1=0,aux2=1;for(let e=0;e<Math.floor(l1Map_height/16);e+=63)arrayChunks.push([aux1]),aux1++;export default class Level1 extends Phaser.Scene{preload(){this.load.image(stem.stem_key,stem.stem_URL)}init(){this.enableKeyboard=!1,this.currentGameState=levelStatesObj.Running;const e=this.sys.game.canvas;e.id="jogo5_canvas",e.style.border=`5px solid ${colors.main_color}`,e.style.borderRadius="20px"}create(){this.cameras.main.fadeIn(transitionFadeDuration,0,0,0),this.cameras.main.once("camerafadeoutcomplete",(e=>{})),this.player=this.physics.add.sprite((l1Map_width+40)*l1Map_scale/2,(l1Map_height-30)*l1Map_scale,userCharacter_objConfig.up.manUp_key).setScale(1.8*l1Map_scale),this.player.body.setSize(4,4),this.player.setDepth(4),this.player.setCollideWorldBounds(!0);const e=this.make.tilemap({key:mapL1_key,tileWidth:16,tileHeight:16});this.loadChunks(this.player.y,l1_tilesetObjConfig,l1_layers_ID),this.cameras.main.setBounds(0,0,e.widthInPixels*l1Map_scale,e.heightInPixels*l1Map_scale),this.cameras.main.setScroll(0,l1Map_height*l1Map_scale),this.physics.world.setBounds(0,0,e.widthInPixels*l1Map_scale,e.heightInPixels*l1Map_scale),this.scene.run(mainUserInterface),this.scene.bringToTop(mainUserInterface),this.createNeededAnimation();e.getObjectLayer(objectsLayers_keys.WallLayerKey).objects.forEach((e=>{e.name,e.rectangle?(this.objRec=this.add.rectangle(e.x*l1Map_scale,e.y*l1Map_scale,e.width*l1Map_scale,e.height*l1Map_scale).setDisplayOrigin(0),this.physics.add.existing(this.objRec,!0),this.physics.add.collider(this.player,this.objRec)):e.ellipse&&(this.objEllips=this.add.circle(e.x*l1Map_scale,e.y*l1Map_scale,e.height*l1Map_scale/2,16711680).setOrigin(0),this.physics.add.existing(this.objEllips,!0),this.physics.add.collider(this.player,this.objEllips))})),this.cursor=this.input.keyboard.createCursorKeys(),this.cronometro=this.time.addEvent({delay:1e3,callback:()=>{level_data.timer+=1},loop:!0}),levelStatesObj.hasBegun=!0;const a=document.getElementById("alternativeMovements"),t=document.getElementById("mute");a.onclick=()=>{a.classList.contains("active")?(a.classList.remove("active"),gameState.accessibleMotionControls=!1,gameState.defaultMotionControls=!0):(a.classList.add("active"),gameState.accessibleMotionControls=!0,gameState.defaultMotionControls=!1)},t.onclick=()=>{t.classList.toggle("active");const e=document.querySelector("#mute_icon");e.classList.toggle("fa-volume-high"),e.classList.toggle("fa-volume-xmark"),1==this.sound.volume?this.sound.volume=0:this.sound.volume=1},gameState.accessibleMotionControls=!0}update(){(this.currentGameState==levelStatesObj.Running||levelStatesObj.hasBegun)&&(gameState.accessibleMotionControls&&this.alternativeCharacterMoveControl(),gameState.defaultMotionControls&&this.handleMainCharacterMovements(),levelStatesObj.hasMapScrolled&&this.keepCharacterInCameraBounds(),this.time.delayedCall(level1_delayMapScrolling,(()=>{0==level_data.aux_controlDelay&&(level_data.aux_controlDelay++,this.toggleKeyboardControl()),this.handleMapScrolling()})),this.cameras.main.update(),this.loadChunks(this.player.y,l1_tilesetObjConfig,l1_layers_ID))}gameLogic(){let e,a=null;levelStatesObj.isMapScrolling&&(this.gameMachineTimer=this.time.addEvent({delay:stemDelay,callback:()=>{for(e=Phaser.Math.Between(1,3);e==a;)e=Phaser.Math.Between(1,3);a=e;let t=0;if(this.cameras.main.scrollY>containerGame_height+100){switch(e){case 1:const e=this.add.image(288*l1Map_scale,this.cameras.main.scrollY-16*l1Map_scale,stem.stem_key).setOrigin(0).setScale(l1Map_scale).setDepth(3);this.physics.add.existing(e,!0),this.physics.add.overlap(this.player,e,(()=>{0==t&&(level_data.hit++,playerState.life>.5?(this.sound.play(level1Songs.lifeAffected.key,level1Songs.lifeAffected.config),playerState.life=playerState.life-.5):(playerState.life=0,this.sound.play(level1Songs.gameOver.key,level1Songs.gameOver.config)),t++)}));break;case 2:const a=this.add.image(336*l1Map_scale,this.cameras.main.scrollY-16*l1Map_scale,stem.stem_key).setOrigin(0).setScale(l1Map_scale).setDepth(3);this.physics.add.existing(a,!0),this.physics.add.overlap(this.player,a,(()=>{0==t&&(level_data.hit++,playerState.life>.5?(this.sound.play(level1Songs.lifeAffected.key,level1Songs.lifeAffected.config),playerState.life=playerState.life-.5):(playerState.life=0,this.sound.play(level1Songs.gameOver.key,level1Songs.gameOver.config)),t++)}));break;case 3:const s=this.add.image(384*l1Map_scale,this.cameras.main.scrollY-16*l1Map_scale,stem.stem_key).setOrigin(0).setScale(l1Map_scale).setDepth(3);this.physics.add.existing(s,!0),this.physics.add.overlap(this.player,s,(()=>{0==t&&(level_data.hit++,playerState.life>.5?(this.sound.play(level1Songs.lifeAffected.key,level1Songs.lifeAffected.config),playerState.life=playerState.life-.5):(playerState.life=0,this.sound.play(level1Songs.gameOver.key,level1Songs.gameOver.config)),t++)}))}0}},loop:!0}))}handleMainCharacterMovements(){if(this.enableKeyboard){const e=levelStatesObj.isMapScrolling&&!this.cursor.left.isDown&&!this.cursor.right.isDown,a=levelStatesObj.isMapScrolling&&this.cursor.up.isDown,t=levelStatesObj.isMapScrolling&&this.cursor.down.isDown,s=levelStatesObj.isMapScrolling?-100:0;e||a||t?(this.player.key=userCharacter_objConfig.up.manUp_key,this.player.play({key:userCharacter_animationsKey.walk_up.key,repeat:0},!0),this.player.setVelocity(0,s)):this.cursor.left.isDown?(this.player.key=userCharacter_objConfig.left.manLeft_key,this.player.play(userCharacter_animationsKey.walk_left.key,!0),this.player.setVelocity(-100,s)):this.cursor.right.isDown?(this.player.key=userCharacter_objConfig.right.manRight_key,this.player.play(userCharacter_animationsKey.walk_right.key,!0),this.player.setVelocity(100,s)):this.cursor.up.isDown?(this.player.key=userCharacter_objConfig.up.manUp_key,this.player.play({key:userCharacter_animationsKey.walk_up.key,repeat:0},!0),this.player.setVelocity(0,-100)):this.cursor.down.isDown?(this.player.key=userCharacter_objConfig.manDown_key,this.player.play(userCharacter_animationsKey.walk_down.key,!0),this.player.setVelocity(0,100)):this.player.setVelocity(0,0)}}alternativeCharacterMoveControl(){const e=levelStatesObj.isMapScrolling?-100:0;if(this.cursor.left.isDown)switch(level_data.playerCollumn){case 2:level_data.isPlayerOnChagingPosition||(level_data.isPlayerOnChagingPosition=!0,this.player.play({key:userCharacter_animationsKey.walk_left.key,repeat:1},!0),this.tweens.add({targets:this.player,x:312*l1Map_scale,duration:350,ease:"Linear",repeat:0,paused:!0,persist:!0,onComplete:()=>{level_data.isPlayerOnChagingPosition=!1,level_data.playerCollumn=1}}).play());break;case 3:this.player.play({key:userCharacter_animationsKey.walk_left.key,repeat:1},!0),level_data.isPlayerOnChagingPosition||(level_data.isPlayerOnChagingPosition=!0,this.player.play({key:userCharacter_animationsKey.walk_left.key,repeat:1},!0),this.tweens.add({targets:this.player,x:360*l1Map_scale,duration:350,ease:"Linear",repeat:0,paused:!0,persist:!0,onComplete:()=>{level_data.isPlayerOnChagingPosition=!1,level_data.playerCollumn=2}}).play())}else if(this.cursor.right.isDown&!playerState.isMoving)switch(level_data.playerCollumn){case 1:this.player.play({key:userCharacter_animationsKey.walk_right.key,repeat:1},!0),level_data.isPlayerOnChagingPosition||(level_data.isPlayerOnChagingPosition=!0,this.player.play({key:userCharacter_animationsKey.walk_left.key,repeat:1},!0),this.tweens.add({targets:this.player,x:360*l1Map_scale,duration:350,ease:"Linear",repeat:0,paused:!0,persist:!0,onComplete:()=>{level_data.isPlayerOnChagingPosition=!1,level_data.playerCollumn=2}}).play());break;case 2:this.player.play({key:userCharacter_animationsKey.walk_right.key,repeat:1},!0),level_data.isPlayerOnChagingPosition||(level_data.isPlayerOnChagingPosition=!0,this.player.play({key:userCharacter_animationsKey.walk_left.key,repeat:1},!0),this.tweens.add({targets:this.player,x:408*l1Map_scale,duration:350,ease:"Linear",repeat:0,paused:!0,persist:!0,onComplete:()=>{level_data.isPlayerOnChagingPosition=!1,level_data.playerCollumn=3}}).play())}else this.player.key=userCharacter_objConfig.up.manUp_key,this.player.play({key:userCharacter_animationsKey.walk_up.key,repeat:0},!0),this.player.setVelocity(0,e)}keepCharacterInCameraBounds(){if("running"==this.currentGameState){const e=this.cameras.main.height;this.player.y>e-this.player.height&&this.player.setVelocityY(-5)}}handleMapScrolling(){this.cameras.main.scrollY>0?(this.cameras.main.scrollY-=level1_SpeedMapScrolling,levelStatesObj.isMapScrolling||(levelStatesObj.isMapScrolling=!0,level_data.running=!0,this.gameLogic())):levelStatesObj.isMapScrolling&&(this.gameMachineTimer.destroy(),console.log("fim"),levelStatesObj.isMapScrolling=!1,levelStatesObj.hasMapScrolled=!0,this.time.removeEvent(this.cronometro),level_data.running=!1,localStorage.setItem("currentLevel",1))}createNeededAnimation(){const e={key:userCharacter_animationsKey.walk_up.key,frames:this.anims.generateFrameNumbers(userCharacter_objConfig.up.manUp_key,{frame:[0,1,2,3]}),frameRate:character_AnimationFrameRate,repeat:0};this.anims.create(e);const a={key:userCharacter_animationsKey.walk_left.key,frames:this.anims.generateFrameNumbers(userCharacter_objConfig.left.manLeft_key,{frame:[0,1,2,3]}),frameRate:character_AnimationFrameRate,repeat:0};this.anims.create(a);const t={key:userCharacter_animationsKey.walk_right.key,frames:this.anims.generateFrameNumbers(userCharacter_objConfig.right.manRight_key,{frame:[0,1,2,3]}),frameRate:character_AnimationFrameRate,repeat:0};this.anims.create(t);const s={key:userCharacter_animationsKey.walk_down.key,frames:this.anims.generateFrameNumbers(userCharacter_objConfig.down.manDown_key,{frame:[0,1,2,3]}),frameRate:character_AnimationFrameRate,repeat:0};this.anims.create(s);const l={key:lifeBart_animationsKey.heart_full.key,frames:this.anims.generateFrameNumbers(lifeBar.lifeBar_key,{start:4,end:0}),frameRate:5,repeat:0};this.anims.create(l);const i={key:lifeBart_animationsKey.heart_half.key,frames:this.anims.generateFrameNumbers(lifeBar.lifeBar_key,{start:0,end:2}),frameRate:3,repeat:0};this.anims.create(i);const r={key:lifeBart_animationsKey.heart_empty.key,frames:this.anims.generateFrameNumbers(lifeBar.lifeBar_key,{start:2,end:4}),frameRate:3,repeat:0};this.anims.create(r)}toggleKeyboardControl(){this.enableKeyboard=!this.enableKeyboard}loadChunks(e,a,t){let s=Math.floor(e/l1Map_scale/1008);for(let e=s;e>=s-1;e--){const s=`0,${e}`;loadedChunks.has(s)?loadedChunks.has("0,"+(e-1))||(e>0&&this.loadChunk(e-1,a,t),loadedChunks.add("0,"+(e-1)),aux2++):(this.loadChunk(e,a,t),e>0&&this.loadChunk(e,a,t),loadedChunks.add(s),aux2++)}}loadChunk(e,a,t){const s=1008*aux2,l=this.make.tilemap({key:`chunk_0_${e}`,tileWidth:16,tileHeight:16});a.forEach((e=>{const a=l.addTilesetImage(e.name,e.key,16,16);tileArray.push(a)})),Object.entries(t).forEach((([e,a],t)=>{l.createLayer(a,tileArray,0,(l1Map_height-s)*l1Map_scale).setScale(l1Map_scale).setDepth(t+1)})),this.load.start()}}export{Level1};